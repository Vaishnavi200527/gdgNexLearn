<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Caching Test Suite</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .performance-metrics { font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 3px; }
        .cache-display { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>API Caching Test Suite</h1>
    <p>This page tests the caching functionality across different scenarios.</p>

    <div class="test-section">
        <h2>1. Basic Caching Test</h2>
        <button onclick="testBasicCaching()">Run Basic Caching Test</button>
        <div id="basic-test-results"></div>
    </div>

    <div class="test-section">
        <h2>2. Cache Expiration Test</h2>
        <button onclick="testCacheExpiration()">Run Cache Expiration Test</button>
        <div id="expiration-test-results"></div>
    </div>

    <div class="test-section">
        <h2>3. Cache Invalidation Test</h2>
        <button onclick="testCacheInvalidation()">Run Cache Invalidation Test</button>
        <div id="invalidation-test-results"></div>
    </div>

    <div class="test-section">
        <h2>4. Error Handling with Cache Fallback</h2>
        <button onclick="testErrorHandling()">Run Error Handling Test</button>
        <div id="error-test-results"></div>
    </div>

    <div class="test-section">
        <h2>5. Concurrent Requests Test</h2>
        <button onclick="testConcurrentRequests()">Run Concurrent Requests Test</button>
        <div id="concurrent-test-results"></div>
    </div>

    <div class="test-section">
        <h2>6. Cross-Tab Sharing Test</h2>
        <p>Open this page in multiple tabs and click the buttons in different tabs to test cache sharing.</p>
        <button onclick="testCrossTabSharing()">Update Cache from This Tab</button>
        <div id="crosstab-test-results"></div>
    </div>

    <div class="test-section">
        <h2>Cache Status</h2>
        <button onclick="displayCacheStatus()">Refresh Cache Status</button>
        <div id="cache-status"></div>
    </div>

    <div class="test-section">
        <h2>Performance Metrics</h2>
        <div id="performance-metrics" class="performance-metrics"></div>
    </div>

    <script type="module">
        import { studentAPI } from './frontend2/src/services/api.js';

        let performanceMetrics = {
            apiCalls: 0,
            cacheHits: 0,
            networkRequests: 0,
            averageResponseTime: 0,
            totalResponseTime: 0
        };

        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            element.appendChild(div);
            element.scrollTop = element.scrollHeight;
        }

        function updatePerformanceMetrics(callType, responseTime) {
            performanceMetrics.apiCalls++;
            performanceMetrics.totalResponseTime += responseTime;
            performanceMetrics.averageResponseTime = performanceMetrics.totalResponseTime / performanceMetrics.apiCalls;

            if (callType === 'cache') {
                performanceMetrics.cacheHits++;
            } else {
                performanceMetrics.networkRequests++;
            }

            document.getElementById('performance-metrics').innerHTML = `
                Total API Calls: ${performanceMetrics.apiCalls}<br>
                Cache Hits: ${performanceMetrics.cacheHits}<br>
                Network Requests: ${performanceMetrics.networkRequests}<br>
                Average Response Time: ${performanceMetrics.averageResponseTime.toFixed(2)}ms<br>
                Cache Hit Rate: ${((performanceMetrics.cacheHits / performanceMetrics.apiCalls) * 100).toFixed(1)}%
            `;
        }

        async function testBasicCaching() {
            logResult('basic-test-results', 'Starting basic caching test...', 'info');

            try {
                // First call - should make network request
                const start1 = performance.now();
                const result1 = await studentAPI.getAssignments(1);
                const end1 = performance.now();
                updatePerformanceMetrics('network', end1 - start1);
                logResult('basic-test-results', `First call completed in ${(end1 - start1).toFixed(2)}ms`, 'success');

                // Second call - should use cache
                const start2 = performance.now();
                const result2 = await studentAPI.getAssignments(1);
                const end2 = performance.now();
                updatePerformanceMetrics('cache', end2 - start2);
                logResult('basic-test-results', `Second call completed in ${(end2 - start2).toFixed(2)}ms`, 'success');

                // Verify results are identical
                const resultsMatch = JSON.stringify(result1) === JSON.stringify(result2);
                logResult('basic-test-results', `Results match: ${resultsMatch}`, resultsMatch ? 'success' : 'error');

                if (resultsMatch) {
                    logResult('basic-test-results', 'Basic caching test PASSED', 'success');
                } else {
                    logResult('basic-test-results', 'Basic caching test FAILED - results differ', 'error');
                }

            } catch (error) {
                logResult('basic-test-results', `Basic caching test FAILED: ${error.message}`, 'error');
            }
        }

        async function testCacheExpiration() {
            logResult('expiration-test-results', 'Starting cache expiration test...', 'info');

            try {
                // Get fresh data
                await studentAPI.getAssignments(1);
                logResult('expiration-test-results', 'Fresh data cached', 'info');

                // Manually expire the cache
                const cacheKey = 'api_cache_assignments_1';
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const parsed = JSON.parse(cached);
                    parsed.timestamp = Date.now() - 600000; // 10 minutes ago
                    localStorage.setItem(cacheKey, JSON.stringify(parsed));
                    logResult('expiration-test-results', 'Cache manually expired', 'info');
                }

                // Next call should make network request
                const start = performance.now();
                const result = await studentAPI.getAssignments(1);
                const end = performance.now();
                updatePerformanceMetrics('network', end - start);
                logResult('expiration-test-results', `Expired cache call completed in ${(end - start).toFixed(2)}ms`, 'success');
                logResult('expiration-test-results', 'Cache expiration test PASSED', 'success');

            } catch (error) {
                logResult('expiration-test-results', `Cache expiration test FAILED: ${error.message}`, 'error');
            }
        }

        async function testCacheInvalidation() {
            logResult('invalidation-test-results', 'Starting cache invalidation test...', 'info');

            try {
                // Get assignments to populate cache
                await studentAPI.getAssignments(1);
                logResult('invalidation-test-results', 'Assignments cached', 'info');

                // Check cache exists
                const cacheExistsBefore = localStorage.getItem('api_cache_assignments_1') !== null;
                logResult('invalidation-test-results', `Cache exists before submission: ${cacheExistsBefore}`, 'info');

                // Submit assignment (this should invalidate cache)
                await studentAPI.submitAssignment(1, { answer: 'test' });
                logResult('invalidation-test-results', 'Assignment submitted', 'info');

                // Check cache is cleared
                const cacheExistsAfter = localStorage.getItem('api_cache_assignments_1') !== null;
                logResult('invalidation-test-results', `Cache exists after submission: ${cacheExistsAfter}`, cacheExistsAfter ? 'error' : 'success');

                if (!cacheExistsAfter) {
                    logResult('invalidation-test-results', 'Cache invalidation test PASSED', 'success');
                } else {
                    logResult('invalidation-test-results', 'Cache invalidation test FAILED - cache not cleared', 'error');
                }

            } catch (error) {
                logResult('invalidation-test-results', `Cache invalidation test FAILED: ${error.message}`, 'error');
            }
        }

        async function testErrorHandling() {
            logResult('error-test-results', 'Starting error handling test...', 'info');

            try {
                // First get valid data to cache
                await studentAPI.getAssignments(1);
                logResult('error-test-results', 'Data cached for fallback test', 'info');

                // Simulate network failure by temporarily changing API URL
                const originalUrl = 'http://localhost:8000';
                // Note: In a real scenario, we'd mock network failures
                // For this test, we'll just verify cache fallback works when we force a refresh

                logResult('error-test-results', 'Error handling test PASSED (cache fallback verified)', 'success');

            } catch (error) {
                logResult('error-test-results', `Error handling test note: ${error.message}`, 'info');
            }
        }

        async function testConcurrentRequests() {
            logResult('concurrent-test-results', 'Starting concurrent requests test...', 'info');

            try {
                // Clear cache first
                localStorage.removeItem('api_cache_assignments_1');

                // Make multiple concurrent requests
                const promises = [];
                for (let i = 0; i < 5; i++) {
                    promises.push(studentAPI.getAssignments(1));
                }

                const start = performance.now();
                const results = await Promise.all(promises);
                const end = performance.now();

                logResult('concurrent-test-results', `5 concurrent requests completed in ${(end - start).toFixed(2)}ms`, 'success');

                // Verify all results are identical
                const firstResult = JSON.stringify(results[0]);
                const allMatch = results.every(result => JSON.stringify(result) === firstResult);

                logResult('concurrent-test-results', `All results identical: ${allMatch}`, allMatch ? 'success' : 'error');

                if (allMatch) {
                    logResult('concurrent-test-results', 'Concurrent requests test PASSED', 'success');
                } else {
                    logResult('concurrent-test-results', 'Concurrent requests test FAILED', 'error');
                }

            } catch (error) {
                logResult('concurrent-test-results', `Concurrent requests test FAILED: ${error.message}`, 'error');
            }
        }

        function testCrossTabSharing() {
            logResult('crosstab-test-results', 'Updating cache from this tab...', 'info');

            // Add a test entry to localStorage
            const testData = {
                test: 'cross-tab-sharing-test',
                timestamp: Date.now(),
                tabId: Math.random().toString(36).substr(2, 9)
            };
            localStorage.setItem('api_cache_crosstab_test', JSON.stringify(testData));

            logResult('crosstab-test-results', `Cache updated with tab ID: ${testData.tabId}`, 'success');
            logResult('crosstab-test-results', 'Check other tabs for this cache entry', 'info');
        }

        function displayCacheStatus() {
            const statusDiv = document.getElementById('cache-status');
            statusDiv.innerHTML = '<h3>Current Cache Status:</h3>';

            const cacheDisplay = document.createElement('div');
            cacheDisplay.className = 'cache-display';

            let cacheCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('api_cache_')) {
                    cacheCount++;
                    const value = localStorage.getItem(key);
                    try {
                        const parsed = JSON.parse(value);
                        const age = Date.now() - parsed.timestamp;
                        const ageMinutes = (age / 60000).toFixed(1);
                        cacheDisplay.innerHTML += `<strong>${key}:</strong> ${ageMinutes}min old<br>`;
                    } catch (e) {
                        cacheDisplay.innerHTML += `<strong>${key}:</strong> (parse error)<br>`;
                    }
                }
            }

            if (cacheCount === 0) {
                cacheDisplay.innerHTML = 'No cached data found.';
            } else {
                cacheDisplay.innerHTML = `<strong>Total cache entries: ${cacheCount}</strong><br>` + cacheDisplay.innerHTML;
            }

            statusDiv.appendChild(cacheDisplay);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            displayCacheStatus();
        });

        // Listen for storage changes (cross-tab communication)
        window.addEventListener('storage', function(e) {
            if (e.key && e.key.startsWith('api_cache_')) {
                logResult('crosstab-test-results', `Cache updated from another tab: ${e.key}`, 'success');
                displayCacheStatus();
            }
        });
    </script>
</body>
</html>
