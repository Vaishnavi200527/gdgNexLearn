<!DOCTYPE html>

<html class="dark" lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AMEP Assignment Detail</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0df2df",
                        "background-light": "#f5f8f8",
                        "background-dark": "#111817",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        'glow-primary': '0 0 15px 0 rgba(13, 242, 223, 0.5), 0 0 5px 0 rgba(13, 242, 223, 0.6)',
                    }
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-background-dark font-display">
<div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<header class="border-b border-indigo-500/20 backdrop-blur-sm bg-[#0F172A]/30">
<div class="container mx-auto px-6 py-4">
<div class="flex justify-between items-center">
<div class="text-xl font-bold tracking-wide bg-gradient-to-r from-blue-500 via-indigo-500 to-teal-500 bg-clip-text text-transparent">
AMEP
</div>
<nav class="hidden md:flex space-x-6">
<a href="student-dashboard.html" class="text-gray-300 hover:text-white transition-colors nav-link" data-page="dashboard">Dashboard</a>
<a href="mastery-tracker.html" class="text-gray-300 hover:text-white transition-colors nav-link" data-page="mastery">Mastery Tracker</a>
<a href="assignments.html" class="text-white font-medium nav-link" data-page="assignments">Assignments</a>
<a href="projects.html" class="text-gray-300 hover:text-white transition-colors nav-link" data-page="projects">Projects</a>
<a href="leaderboard.html" class="text-gray-300 hover:text-white transition-colors nav-link" data-page="leaderboard">Leaderboard</a>
<a href="badges.html" class="text-gray-300 hover:text-white transition-colors nav-link" data-page="badges">Badges</a>
</nav>
<div class="flex items-center space-x-4">
<button id="mobile-menu-toggle" class="md:hidden text-gray-400 hover:text-white focus:outline-none">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
</svg>
</button>
<span class="text-gray-300 hidden sm:inline" id="user-name">John Doe</span>
<div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center">
<span class="font-bold" id="user-initials">JD</span>
</div>
<a href="#" id="desktop-logout-btn" class="hidden md:block text-gray-300 hover:text-white transition-colors">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
</svg>
</a>
</div>
</div>
</div>
</header>
<main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
<div class="flex flex-wrap gap-2 mb-8">
<a class="text-[#9cbab7] text-sm font-medium leading-normal hover:text-primary transition-colors" href="#">Courses</a>
<span class="text-[#9cbab7] text-sm font-medium leading-normal">/</span>
<a class="text-[#9cbab7] text-sm font-medium leading-normal hover:text-primary transition-colors" href="#">CS 101</a>
<span class="text-[#9cbab7] text-sm font-medium leading-normal">/</span>
<a class="text-[#9cbab7] text-sm font-medium leading-normal hover:text-primary transition-colors" href="#">Assignments</a>
<span class="text-[#9cbab7] text-sm font-medium leading-normal">/</span>
<span class="text-white text-sm font-medium leading-normal">Generative Art with p5.js</span>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- Left Column: Information -->
<div class="flex flex-col gap-8">
<div>
<h1 class="text-white text-4xl lg:text-5xl font-black tracking-tighter text-shadow-[0_0_15px_rgba(13,242,223,0.4)]">Assignment: Generative Art with p5.js</h1>
<p class="text-[#9cbab7] text-base font-normal leading-normal mt-3">Due: Dec 15, 2024 | <span class="text-yellow-400">In Progress</span> | 100 Points</p>
</div>
<div class="bg-white/5 backdrop-blur-md rounded-xl border border-white/10 p-6">
<h2 class="text-white text-xl font-bold mb-3">Description</h2>
<p class="text-[#c1d3d1] text-base font-normal leading-relaxed">This assignment challenges you to create a dynamic, interactive piece of generative art using the p5.js library. Explore concepts of randomness, loops, and user input to build a unique visual experience. The goal is to apply fundamental programming concepts in a creative context.</p>
</div>

<!-- PDF Display Section - Always visible -->
<div id="pdf-section" class="bg-white/5 backdrop-blur-md rounded-xl border border-primary/30 p-6">
<h2 class="text-white text-xl font-bold mb-3 flex items-center gap-2">
<span class="material-symbols-outlined text-primary">description</span>
Original Assignment Materials (PDF)
</h2>
<div id="pdf-content" class="text-[#c1d3d1] text-base font-normal leading-relaxed">
<!-- PDF content will be loaded here -->
<div class="animate-pulse">
<div class="h-4 bg-gray-600 rounded w-3/4 mb-2"></div>
<div class="h-4 bg-gray-600 rounded w-1/2 mb-2"></div>
<div class="h-4 bg-gray-600 rounded w-5/6 mb-2"></div>
<div class="h-4 bg-gray-600 rounded w-2/3 mb-2"></div>
<div class="h-4 bg-gray-600 rounded w-4/5"></div>
</div>
<p class="mt-4 text-sm text-[#9cbab7]">Loading assignment materials...</p>
</div>
</div>
<div class="flex flex-col gap-4">
<h2 class="text-white text-xl font-bold">Learning Objectives</h2>
<div class="grid sm:grid-cols-2 gap-4">
<div class="relative p-5 bg-[#1a2e2c] border border-primary/50 rounded-lg overflow-hidden transition-all hover:border-primary">
<div class="absolute -top-1 -right-1 w-16 h-16 bg-primary/20 rounded-bl-full blur-2xl"></div>
<div class="flex items-center gap-4">
<div class="flex-shrink-0 text-primary">
<span class="material-symbols-outlined text-3xl">code</span>
</div>
<div>
<h3 class="font-bold text-white">p5.js Basics</h3>
<p class="text-sm text-[#9cbab7]">Understand the setup and draw loops.</p>
</div>
</div>
</div>
<div class="relative p-5 bg-[#1a2e2c] border border-primary/50 rounded-lg overflow-hidden transition-all hover:border-primary">
<div class="absolute -top-1 -right-1 w-16 h-16 bg-primary/20 rounded-bl-full blur-2xl"></div>
<div class="flex items-center gap-4">
<div class="flex-shrink-0 text-primary">
<span class="material-symbols-outlined text-3xl">gesture</span>
</div>
<div>
<h3 class="font-bold text-white">Interactivity</h3>
<p class="text-sm text-[#9cbab7]">Use mouse and keyboard inputs.</p>
</div>
</div>
</div>
<div class="relative p-5 bg-[#1a2e2c] border border-primary/50 rounded-lg overflow-hidden transition-all hover:border-primary">
<div class="absolute -top-1 -right-1 w-16 h-16 bg-primary/20 rounded-bl-full blur-2xl"></div>
<div class="flex items-center gap-4">
<div class="flex-shrink-0 text-primary">
<span class="material-symbols-outlined text-3xl">shuffle</span>
</div>
<div>
<h3 class="font-bold text-white">Randomness</h3>
<p class="text-sm text-[#9cbab7]">Implement random functions for variety.</p>
</div>
</div>
</div>
<div class="relative p-5 bg-[#1a2e2c] border border-primary/50 rounded-lg overflow-hidden transition-all hover:border-primary">
<div class="absolute -top-1 -right-1 w-16 h-16 bg-primary/20 rounded-bl-full blur-2xl"></div>
<div class="flex items-center gap-4">
<div class="flex-shrink-0 text-primary">
<span class="material-symbols-outlined text-3xl">palette</span>
</div>
<div>
<h3 class="font-bold text-white">Color Theory</h3>
<p class="text-sm text-[#9cbab7]">Apply color to create mood and focus.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Right Column: Task Completion -->
<div class="flex flex-col bg-[#162928] border border-white/10 rounded-xl overflow-hidden min-h-[700px]">
<div class="flex-grow flex flex-col items-center justify-center p-8">
<div class="text-center">
<div class="text-6xl mb-6">ðŸŽ¯</div>
<h3 class="text-2xl font-bold text-white mb-4">Ready to Complete Your Assignment?</h3>
<p class="text-[#c1d3d1] text-lg mb-8 max-w-md">Review the materials, study the AI-powered explanations, and click below when you're ready to demonstrate your understanding.</p>
<button id="complete-task-btn" class="flex min-w-[200px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-blue-600 text-white text-lg font-bold leading-normal tracking-[0.015em] hover:bg-blue-700 transition-colors shadow-lg">
<span class="truncate">Complete the Task</span>
</button>
<p class="text-[#9cbab7] text-sm mt-4">This will generate a personalized knowledge check quiz based on your mastery level.</p>
</div>
</div>
<!-- Quiz Section -->
<div id="quiz-section" class="p-4 border-t border-white/10 hidden">
<h3 class="text-lg font-bold text-white mb-4">Knowledge Check Quiz</h3>
<div id="quiz-content" class="space-y-4">
<!-- Quiz questions will be loaded here -->
</div>
<div class="flex items-center justify-end gap-3 mt-6">
<button id="submit-quiz-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-green-600 text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-700 transition-colors">
<span class="truncate">Submit Quiz</span>
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Mobile Navigation Overlay -->
<div id="mobile-nav-overlay" class="fixed inset-0 bg-black/80 z-50 hidden md:hidden">
<div class="flex flex-col h-full">
<div class="flex justify-between items-center p-6 border-b border-gray-800">
<div class="text-xl font-bold bg-gradient-to-r from-blue-500 via-indigo-500 to-teal-500 bg-clip-text text-transparent">
AMEP
</div>
<button id="close-mobile-nav" class="text-gray-400 hover:text-white">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
</svg>
</button>
</div>

<nav class="flex-col p-6 space-y-6">
<a href="student-dashboard.html" class="text-gray-400 hover:text-white text-lg py-2 transition-colors">Dashboard</a>
<a href="mastery-tracker.html" class="text-gray-400 hover:text-white text-lg py-2 transition-colors">Mastery Tracker</a>
<a href="assignments.html" class="text-white font-medium text-lg py-2 border-l-4 border-blue-500 pl-4">Assignments</a>
<a href="projects.html" class="text-gray-400 hover:text-white text-lg py-2 transition-colors">Projects</a>
<a href="leaderboard.html" class="text-gray-400 hover:text-white text-lg py-2 transition-colors">Leaderboard</a>
<a href="badges.html" class="text-gray-400 hover:text-white text-lg py-2 transition-colors">Badges</a>
<div class="border-t border-gray-800 pt-6 mt-6">
<a href="#" class="text-gray-400 hover:text-white text-lg py-2 transition-colors">Settings</a>
<a href="#" id="logout-btn" class="text-gray-400 hover:text-white text-lg py-2 transition-colors">Logout</a>
</div>
</nav>
</div>
</div>

</main>
</div>
</div>

<script type="module">
    // Import services
    import { studentAPI } from '../src/services/api.js';
    import { logout } from '../src/services/auth.js';

    // Make API available globally for debugging
    window.studentAPI = studentAPI;

    // --- State Management ---
    let quizDataStore = null;

    // --- DOM Elements ---
    // --- UI Update Functions ---

    function updateUserNameDisplay() {
        const userName = localStorage.getItem('userName') || 'Student';
        const userNameElement = document.getElementById('user-name');
        if (userNameElement) {
            userNameElement.textContent = userName;
        }
        const userInitialsElement = document.getElementById('user-initials');
        if (userInitialsElement) {
            const names = userName.split(' ');
            let initials = '';
            if (names.length > 1) {
                initials = names[0].charAt(0) + (names[names.length - 1].charAt(0) || '');
            } else {
                initials = names[0].charAt(0) + (names[0].charAt(1) || '');
            }
            userInitialsElement.textContent = initials.toUpperCase() || 'ST';
        }
    }

    function updateAssignmentDetails(assignment) {
        const titleElement = document.querySelector('h1.text-white.text-4xl');
        if (titleElement) {
            titleElement.textContent = `Assignment: ${assignment.title}`;
        }

        const metaElement = document.querySelector('p.text-\\[\\#9cbab7\\].text-base');
        if (metaElement) {
            const statusClass = {
                'completed': 'text-green-400',
                'in progress': 'text-yellow-400',
                'not started': 'text-gray-400',
                'overdue': 'text-red-400'
            }[assignment.status.toLowerCase()] || 'text-gray-400';

            metaElement.innerHTML = `Due: ${assignment.dueDate} | <span class="${statusClass}">${assignment.status}</span> | ${assignment.points} Points`;
        }

        const descriptionElement = document.querySelector('.bg-white\\/5.p-6 p');
        if (descriptionElement) {
            descriptionElement.textContent = assignment.description;
        }
    }

    function updateConceptExplanations(explanationText, masteryScore = 0) {
        const descriptionSection = document.querySelector('.bg-white\\/5.backdrop-blur-md.rounded-xl.border.border-white\\/10.p-6');
        if (!descriptionSection) return;

        const existingConceptsSection = document.querySelector('.concepts-section');
        if (existingConceptsSection) {
            existingConceptsSection.remove();
        }

        const masteryLevels = {
            beginner: { icon: 'school', description: 'Building foundational knowledge', bgColor: 'bg-blue-900/20', borderColor: 'border-blue-500/30' },
            intermediate: { icon: 'trending_up', description: 'Developing good understanding', bgColor: 'bg-yellow-900/20', borderColor: 'border-yellow-500/30' },
            advanced: { icon: 'stars', description: 'Mastering complex concepts', bgColor: 'bg-green-900/20', borderColor: 'border-green-500/30' }
        };

        let masteryLevel = 'beginner';
        if (masteryScore >= 80) masteryLevel = 'advanced';
        else if (masteryScore >= 60) masteryLevel = 'intermediate';

        const { icon: masteryIcon, description: masteryDescription, bgColor: masteryBgColor, borderColor: masteryBorderColor } = masteryLevels[masteryLevel];

        let formattedExplanation = '';
        if (typeof explanationText === 'object' && explanationText !== null) {
            let html = '';
            html += `<div class="flex items-center gap-2 mb-4 p-3 ${masteryBgColor} rounded-lg ${masteryBorderColor}"><span class="material-symbols-outlined text-primary text-xl">${masteryIcon}</span><div><p class="text-white text-sm font-semibold">AI-Powered Learning Level: ${masteryLevel.charAt(0).toUpperCase() + masteryLevel.slice(1)}</p><p class="text-[#9cbab7] text-xs">${masteryDescription} (${masteryScore}% mastery)</p></div></div>`;
            if (masteryScore < 60) html += `<div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-4"><p class="text-blue-300 text-sm font-medium mb-2">ðŸ‘‹ Hey there! Let's start with the fundamentals</p><p class="text-[#c1d3d1] text-sm">I'll explain this step-by-step using the assignment document. We'll break down complex ideas into simple parts.</p></div>`;
            else if (masteryScore >= 60 && masteryScore < 80) html += `<div class="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-4 mb-4"><p class="text-yellow-300 text-sm font-medium mb-2">ðŸš€ You're making great progress!</p><p class="text-[#c1d3d1] text-sm">Based on the document, I'll focus on practical applications and deeper connections to what you already know.</p></div>`;
            else html += `<div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4 mb-4"><p class="text-green-300 text-sm font-medium mb-2">ðŸŽ¯ Ready for advanced concepts!</p><p class="text-[#c1d3d1] text-sm">You have a solid grasp of the fundamentals. Let's explore the advanced nuances found in the provided material.</p></div>`;

            if (explanationText.definition) {
                let definition = explanationText.definition.replace(/\n/g, ' ').trim();
                if (masteryScore < 60) definition += " (Think of this as the 'what' - we'll cover the 'how' and 'why' next!)";
                else if (masteryScore >= 80) definition += " (Building on your existing knowledge, let's see how this fits into larger systems.)";
                html += `<div class="bg-[#1a2e2c] p-4 rounded-lg border-l-4 border-primary mb-4"><p class="text-[#c1d3d1] text-base font-normal leading-relaxed">${definition}</p></div>`;
            }

            if (explanationText.detailed_explanation) {
                let detailedText = explanationText.detailed_explanation;
                if (masteryScore < 60) {
                    detailedText = detailedText.replace(/p5\.js/g, '<strong class="text-primary">p5.js</strong>').replace(/function/g, '<em class="text-yellow-300">function</em>').replace(/setup\(\)/g, '<code class="bg-[#111817] px-1 rounded text-green-300">setup()</code>').replace(/draw\(\)/g, '<code class="bg-[#111817] px-1 rounded text-green-300">draw()</code>');
                    html += `<div class="mb-4"><h4 class="text-white text-md font-semibold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-primary text-lg">school</span>Let's Break This Down Step-by-Step</h4><div class="text-[#c1d3d1] text-base font-normal leading-relaxed space-y-3">${detailedText.replace(/\n\n/g, '</p><p class="mb-3">').replace(/\n/g, '<br>')}</div></div>`;
                    html += `<div class="bg-green-900/20 border border-green-500/30 rounded-lg p-4 mb-4"><h5 class="text-green-300 text-sm font-semibold mb-2">ðŸ’¡ Pro Tips for Beginners:</h5><ul class="text-[#c1d3d1] text-sm space-y-1"><li>â€¢ Start with simple shapes before adding complexity</li><li>â€¢ Use console.log() to debug your code</li><li>â€¢ Experiment with different values to see what happens</li><li>â€¢ Don't be afraid to make mistakes - they're how you learn!</li></ul></div>`;
                } else if (masteryScore >= 60 && masteryScore < 80) {
                    html += `<div class="mb-4"><h4 class="text-white text-md font-semibold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-primary text-lg">build</span>Practical Applications & Connections</h4><div class="text-[#c1d3d1] text-base font-normal leading-relaxed">${detailedText.replace(/\n/g, '<br>')}</div></div>`;
                    html += `<div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-4 mb-4"><h5 class="text-purple-300 text-sm font-semibold mb-2">ðŸŽ¯ Challenge Yourself:</h5><p class="text-[#c1d3d1] text-sm">Try combining multiple concepts in one sketch. How would you create an interactive scene that responds to both mouse and keyboard input?</p></div>`;
                } else {
                    html += `<div class="mb-4"><h4 class="text-white text-md font-semibold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-primary text-lg">psychology</span>Advanced Concepts & Optimization</h4><div class="text-[#c1d3d1] text-base font-normal leading-relaxed">${detailedText.replace(/\n/g, '<br>')}</div><div class="mt-4 p-3 bg-[#1a2e2c] rounded-lg border border-primary/20"><p class="text-primary text-sm font-medium mb-2">ðŸš€ Performance Optimization Tip:</p><p class="text-[#9cbab7] text-sm">Consider using <code class="bg-[#111817] px-1 rounded">frameRate()</code> to control animation speed and <code class="bg-[#111817] px-1 rounded">noLoop()</code> for static compositions to improve performance.</p></div></div>`;
                }
            }

            if (explanationText.key_points && explanationText.key_points.length > 0) {
                html += `<div class="mb-4"><h4 class="text-white text-md font-semibold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-primary text-lg">check_circle</span>Key Takeaways</h4><div class="grid gap-2">`;
                explanationText.key_points.forEach((point) => {
                    const isImportant = masteryScore < 60 && (point.toLowerCase().includes('basic') || point.toLowerCase().includes('fundamental'));
                    const pointClass = isImportant ? 'border-primary bg-primary/10' : 'border-white/10';
                    const icon = masteryScore < 60 ? 'star' : masteryScore < 80 ? 'arrow_right' : 'lightbulb';
                    html += `<div class="flex items-start gap-3 p-3 bg-[#1a2e2c] rounded-lg border ${pointClass} transition-all hover:border-primary/50"><span class="material-symbols-outlined text-primary text-lg mt-0.5 flex-shrink-0">${icon}</span><p class="text-[#c1d3d1] text-sm leading-relaxed">${point.replace(/\n/g, ' ').trim()}</p></div>`;
                });
                html += `</div></div>`;
            }

            if (explanationText.examples && explanationText.examples.length > 0) {
                html += `<div class="mb-4"><h4 class="text-white text-md font-semibold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-primary text-lg">code</span>Hands-On Examples</h4>`;
                if (masteryScore < 60) html += `<p class="text-[#9cbab7] text-sm mb-3">Let's look at some beginner-friendly code examples. Try copying these into your p5.js editor and experimenting with the values!</p>`;
                else if (masteryScore >= 80) html += `<p class="text-[#9cbab7] text-sm mb-3">These examples demonstrate advanced techniques. Consider how you might extend them for your own projects.</p>`;
                explanationText.examples.forEach((example, index) => {
                    const exampleCode = typeof example === 'string' ? example : example.code || '';
                    const exampleTitle = typeof example === 'object' && example.title ? example.title : (masteryScore < 60 ? ['Your First Circle', 'Adding Color', 'Mouse Interaction'][index] || `Example ${index + 1}` : ['Advanced Animation', 'Complex Interactions', 'Performance Optimization'][index] || `Example ${index + 1}`);
                    html += `<div class="bg-[#111817] p-4 rounded-lg border border-white/10 mb-3"><div class="flex items-center justify-between mb-2"><h5 class="text-white text-sm font-semibold">${exampleTitle}</h5><button class="text-primary text-xs hover:text-primary/80 underline" onclick="navigator.clipboard.writeText(\`${exampleCode.replace(/`/g, '\\`')}\`)">Copy Code</button></div><pre class="text-green-300 text-xs overflow-x-auto"><code>${exampleCode.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre></div>`;
                });
                html += `</div>`;
            }

            if (explanationText.related_terms && explanationText.related_terms.length > 0) {
                html += `<div class="mb-4"><h4 class="text-white text-md font-semibold mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-primary text-lg">link</span>Connected Concepts</h4><div class="flex flex-wrap gap-2">`;
                explanationText.related_terms.forEach(term => {
                    html += `<span class="px-3 py-1 bg-[#1a2e2c] text-[#9cbab7] text-sm rounded-full border border-white/10 hover:border-primary/50 transition-colors cursor-pointer">${term}</span>`;
                });
                html += `</div></div>`;
            }

            if (masteryScore < 60) html += `<div class="bg-gradient-to-r from-blue-900/20 to-purple-900/20 border border-primary/30 rounded-lg p-4"><h5 class="text-primary text-sm font-semibold mb-2">ðŸŽ¯ Your Next Steps:</h5><ul class="text-[#c1d3d1] text-sm space-y-1"><li>â€¢ Practice creating basic shapes and understanding coordinates</li><li>â€¢ Experiment with the setup() and draw() functions</li><li>â€¢ Try the examples above in your own p5.js sketch</li><li>â€¢ Join online communities to see what others are creating!</li></ul></div>`;
            else if (masteryScore >= 60 && masteryScore < 80) html += `<div class="bg-gradient-to-r from-yellow-900/20 to-orange-900/20 border border-yellow-500/30 rounded-lg p-4"><h5 class="text-yellow-300 text-sm font-semibold mb-2">ðŸš€ Level Up Your Skills:</h5><ul class="text-[#c1d3d1] text-sm space-y-1"><li>â€¢ Combine multiple interactive elements in one sketch</li><li>â€¢ Explore p5.js libraries for extended functionality</li><li>â€¢ Study existing projects and understand their structure</li><li>â€¢ Start planning your own creative coding project!</li></ul></div>`;
            else html += `<div class="bg-gradient-to-r from-green-900/20 to-teal-900/20 border border-green-500/30 rounded-lg p-4"><h5 class="text-green-300 text-sm font-semibold mb-2">ðŸŽ¨ Master Level Challenges:</h5><ul class="text-[#c1d3d1] text-sm space-y-1"><li>â€¢ Optimize your code for better performance</li><li>â€¢ Create interactive installations or games</li><li>â€¢ Explore generative art algorithms and mathematical concepts</li><li>â€¢ Contribute to the p5.js community or create tutorials for others!</li></ul></div>`;
            
            formattedExplanation = html || `<p class="text-[#c1d3d1] text-base font-normal leading-relaxed">Concept explanation data is available but could not be formatted properly.</p>`;
        } else {
            formattedExplanation = `<p class="text-[#c1d3d1] text-base font-normal leading-relaxed">${explanationText}</p>`;
        }

        const conceptsSection = document.createElement('div');
        conceptsSection.className = 'bg-white/5 backdrop-blur-md rounded-xl border border-white/10 p-6 concepts-section';
        conceptsSection.innerHTML = `<h2 class="text-white text-xl font-bold mb-3">AI-Powered Concept Explanations</h2>${formattedExplanation}`;
        descriptionSection.insertAdjacentElement('afterend', conceptsSection);
    }

    async function loadPDFContent(assignment) {
        try {
            const contentUrl = assignment.content_url;
            const fullUrl = contentUrl.startsWith('http') ? contentUrl : `http://localhost:8000${contentUrl.startsWith('/') ? '' : '/'}${contentUrl}`;
            const pdfSection = document.getElementById('pdf-section');
            const pdfContent = document.getElementById('pdf-content');
            
            if (pdfSection && pdfContent) {
                pdfSection.classList.remove('hidden');
                
                pdfContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="pdf-title" class="text-lg font-semibold text-white">ðŸ“„ ${assignment.title} (PDF)</h3>
                        <button id="pdf-download-btn" onclick="window.downloadPDF(event, '${contentUrl}', '${assignment.title.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-primary/20 text-primary text-sm rounded-md hover:bg-primary/30 transition-colors flex items-center gap-2"><span class="material-symbols-outlined text-sm">download</span> Download PDF</button>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading PDF content:', error);
            const pdfContent = document.getElementById('pdf-content');
            if (pdfContent) {
                pdfContent.innerHTML = `<div class="text-red-400">Could not load PDF content.</div>`;
            }
        }
    }

    async function downloadPDF(event, pdfUrl, filename) {
        try {
            const downloadBtn = event.target.closest('button');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = 'Downloading...';
            downloadBtn.disabled = true;

            const fullUrl = pdfUrl.startsWith('http') ? pdfUrl : `http://localhost:8000${pdfUrl.startsWith('/') ? '' : '/'}${pdfUrl}`;

            const response = await fetch(fullUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename ? `${filename}.pdf` : 'assignment.pdf';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            downloadBtn.innerHTML = originalText;
            downloadBtn.disabled = false;
        } catch (error) {
            console.error('Error downloading PDF:', error);
            alert('Failed to download PDF. Please try again.');
            const downloadBtn = event.target.closest('button');
            downloadBtn.innerHTML = 'Download';
            downloadBtn.disabled = false;
        }
    }
    window.downloadPDF = downloadPDF;

    async function fetchAssignmentDetails(id) {
        try {
            const assignment = await studentAPI.getAssignmentById(id);
            const conceptsData = await studentAPI.getAssignmentConcepts(id, 'comprehensive');
            
            const transformedAssignment = {
                title: assignment.title,
                description: assignment.description,
                dueDate: assignment.due_date ? new Date(assignment.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A',
                status: assignment.status || 'In Progress',
                points: assignment.score !== null ? assignment.score : (assignment.points || 100),
                objectives: [
                    'Demonstrate understanding of core concepts',
                    'Apply knowledge to solve practical problems',
                    'Develop critical thinking skills'
                ]
            };
            
            updateAssignmentDetails(transformedAssignment);
            
            if (conceptsData && conceptsData.success && conceptsData.explanation) {
                updateConceptExplanations(conceptsData.explanation, conceptsData.mastery_score);
            } else {
                const conceptsSection = document.querySelector('.concepts-section');
                if (conceptsSection) {
                    conceptsSection.innerHTML = `<h2 class="text-white text-xl font-bold mb-3">AI-Powered Concept Explanations</h2><p class="text-[#c1d3d1]">No concept explanations available for this assignment yet.</p>`;
                }
            }

            if (assignment.content_url) {
                loadPDFContent(assignment);
            } else {
                const pdfSection = document.getElementById('pdf-section');
                const pdfContent = document.getElementById('pdf-content');
                if (pdfSection && pdfContent) {
                    pdfSection.classList.remove('hidden');
                    pdfContent.innerHTML = `<div class="text-center py-8"><div class="text-4xl mb-4">ðŸ“„</div><p class="text-[#c1d3d1] mb-2">No PDF materials available for this assignment</p><p class="text-[#9cbab7] text-sm">The assignment instructions are provided in the description above. Check back later for any additional materials your instructor may upload.</p></div>`;
                }
            }
        } catch (error) {
            console.error('Error fetching assignment details:', error);
            document.querySelector('h1').textContent = 'Error Loading Assignment';
        }
    }

    // --- Quiz Functions ---
    async function handleCompleteTask() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const assignmentId = urlParams.get('id');
            if (!assignmentId) {
                alert('Assignment ID not found');
                return;
            }

            // Request 10 questions for the quiz
            const quizData = await studentAPI.getAssignmentQuiz(assignmentId, 10);
            quizDataStore = quizData;

            const quizSection = document.getElementById('quiz-section');
            const quizContent = document.getElementById('quiz-content');
            if (quizSection && quizContent && quizData.questions) {
                renderQuiz(quizData.questions);
                quizSection.classList.remove('hidden');
                quizSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('No quiz available for this assignment yet.');
            }
        } catch (error) {
            console.error('Error loading quiz:', error);
            alert('Failed to load quiz. Please try again later.');
        }
    }

    function renderQuiz(questions) {
        const quizContent = document.getElementById('quiz-content');
        quizContent.innerHTML = '';
        questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'bg-[#1a2e2c] p-4 rounded-lg border border-primary/20';
            let questionHTML = `<h4 class="text-white text-lg font-semibold mb-3">${index + 1}. ${question.question}</h4>`;
            if (question.type === 'multiple_choice') {
                question.options.forEach(option => {
                    questionHTML += `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-primary/10 text-[#c1d3d1] cursor-pointer hover:text-white transition-colors"><input type="radio" name="question-${index}" value="${option}" class="text-primary focus:ring-primary bg-transparent border-gray-500"><span>${option}</span></label>`;
                });
            } else if (question.type === 'true_false') {
                questionHTML += `<label class="flex items-center space-x-3 text-[#c1d3d1] cursor-pointer hover:text-white transition-colors"><input type="radio" name="question-${index}" value="True" class="text-primary focus:ring-primary"><span>True</span></label><label class="flex items-center space-x-3 text-[#c1d3d1] cursor-pointer hover:text-white transition-colors"><input type="radio" name="question-${index}" value="False" class="text-primary focus:ring-primary"><span>False</span></label>`;
            } else if (question.type === 'short_answer') {
                questionHTML += `<textarea name="question-${index}" rows="3" class="w-full bg-[#111817] border border-primary/30 rounded-lg p-3 text-[#c1d3d1] placeholder-[#9cbab7] focus:border-primary focus:outline-none" placeholder="Enter your answer here..."></textarea>`;
            }
            questionDiv.innerHTML = questionHTML;
            quizContent.appendChild(questionDiv);
        });
    }

    async function handleSubmitQuiz() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const assignmentId = urlParams.get('id');
            const answers = [];
            
            const quizContent = document.getElementById('quiz-content');
            const questionDivs = quizContent.querySelectorAll('.bg-\\[\\#1a2e2c\\]');
            questionDivs.forEach((div, index) => {
                const radioInput = div.querySelector('input[type="radio"]:checked');
                const textInput = div.querySelector('textarea');
                if (radioInput) answers.push({ questionIndex: index, answer: radioInput.value });
                else if (textInput) answers.push({ questionIndex: index, answer: textInput.value.trim() });
            });

            const submissionPayload = { questions: quizDataStore.questions, answers: answers };
            const result = await studentAPI.submitAssignmentQuiz(assignmentId, submissionPayload);
            showQuizResults(result);
        } catch (error) {
            console.error('Error submitting quiz:', error);
            alert('Failed to submit quiz. Please try again.');
        }
    }

    function showQuizResults(result) {
        const quizContent = document.getElementById('quiz-content');
        let resultHTML = `<div class="text-center py-6"><div class="text-6xl mb-4">${result.score >= 70 ? 'ðŸŽ‰' : 'ðŸ“š'}</div><h3 class="text-2xl font-bold text-white mb-2">${result.score >= 70 ? 'Congratulations!' : 'Keep Learning!'}</h3><p class="text-[#c1d3d1] text-lg mb-4">You scored ${result.score}% on the knowledge check.</p><div class="bg-[#1a2e2c] p-4 rounded-lg border border-primary/20 mb-4"><p class="text-[#9cbab7] text-sm">Correct answers: ${result.correct}/${result.total}</p></div>`;
        if (result.score >= 70) {
            resultHTML += `<p class="text-[#c1d3d1] mb-4">Great job! You've demonstrated good understanding of the concepts. Your assignment has been marked as complete.</p><button onclick="window.location.reload()" class="bg-primary text-background-dark px-6 py-2 rounded-lg font-semibold hover:bg-opacity-80 transition-opacity">Return to Assignment</button>`;
        } else {
            resultHTML += `<p class="text-[#c1d3d1] mb-4">You might want to review the concepts and try again. Check the AI-powered explanations above for additional guidance.</p><button onclick="window.location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Review and Try Again</button>`;
        }
        resultHTML += `</div>`;
        quizContent.innerHTML = resultHTML;
        
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        if (submitQuizBtn) submitQuizBtn.style.display = 'none';
    }

    // --- Mobile Nav & Auth ---
    function setupMobileNavigation() {
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        const closeMobileNav = document.getElementById('close-mobile-nav');
        if (mobileMenuToggle && mobileNavOverlay && closeMobileNav) {
            mobileMenuToggle.addEventListener('click', () => mobileNavOverlay.classList.remove('hidden'));
            closeMobileNav.addEventListener('click', () => mobileNavOverlay.classList.add('hidden'));
            mobileNavOverlay.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => mobileNavOverlay.classList.add('hidden'));
            });
        }
    }

    function setupAuthButtons() {
        const logoutBtn = document.getElementById('logout-btn');
        const desktopLogoutBtn = document.getElementById('desktop-logout-btn');
        const handleLogout = (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        };
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        if (desktopLogoutBtn) desktopLogoutBtn.addEventListener('click', handleLogout);
    }

    // Expose functions to window for HTML onclick attributes
    window.handleCompleteTask = handleCompleteTask;
    window.handleSubmitQuiz = handleSubmitQuiz;

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const assignmentId = urlParams.get('id');

        if (assignmentId) {
            fetchAssignmentDetails(assignmentId);
        } else {
            document.querySelector('h1').textContent = 'Assignment Not Found';
            document.querySelector('p.text-\\[\\#9cbab7\\].text-base').textContent = 'Please check the URL and make sure an assignment ID is provided.';
        }

        updateUserNameDisplay();
        setupMobileNavigation();
        setupAuthButtons();

        const completeTaskBtn = document.getElementById('complete-task-btn');
        if (completeTaskBtn) {
            completeTaskBtn.addEventListener('click', handleCompleteTask);
        }
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        if (submitQuizBtn) {
            submitQuizBtn.addEventListener('click', handleSubmitQuiz);
        }
    });
</script>
</body></html>