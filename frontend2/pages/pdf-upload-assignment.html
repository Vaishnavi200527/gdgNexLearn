<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Upload PDF and Create Assignment - AMEP</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0db9f2",
                        "background-light": "#f5f8f8",
                        "background-dark": "#101e22",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        'glow-primary': '0 0 15px 2px rgba(13, 185, 242, 0.5), 0 0 5px 0px rgba(13, 185, 242, 0.7)',
                        'glow-primary-strong': '0 0 25px 5px rgba(13, 185, 242, 0.7), 0 0 10px 2px rgba(13, 185, 242, 0.8)',
                    }
                },
            },
        }
    </script>
    <style>
        .form-select, .form-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: 'expand_more';
            font-family: 'Material Symbols Outlined';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #9cb2ba;
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .upload-area {
            border: 2px dashed #3b4e54;
            transition: all 0.3s ease;
        }
        .upload-area.drag-over {
            border-color: #0db9f2;
            background-color: rgba(13, 185, 242, 0.05);
        }
        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 14px;
            left: 50%;
            right: -50%;
            height: 2px;
            background-color: #3b4e54;
            z-index: 1;
        }
        .step.active::after {
            background-color: #0db9f2;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #3b4e54;
            color: #9cb2ba;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            position: relative;
            z-index: 2;
        }
        .step.active .step-number {
            background-color: #0db9f2;
            color: #101e22;
        }
        .step.completed .step-number {
            background-color: #0db9f2;
            color: #101e22;
        }
        .step.completed .step-number::after {
            content: 'check';
            font-family: 'Material Symbols Outlined';
            font-variation-settings: 'FILL' 1;
        }
    </style>
</head>
<body class="font-display bg-background-dark">
    <div class="relative flex h-auto min-h-screen w-full flex-col">
        <div class="layout-container flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#283539] px-10 py-3 sticky top-0 bg-background-dark/80 backdrop-blur-sm z-50">
                <div class="flex items-center gap-4 text-white">
                    <img src="../assets/logo.png" alt="AMEP Logo" class="h-8 w-8 text-primary" />
                    <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">AMEP</h2>
                </div>
                <div class="flex flex-1 justify-center gap-8">
                    <div class="flex items-center gap-9">
                        <a class="text-white/70 hover:text-white transition-colors text-sm font-medium leading-normal" href="teacher-dashboard.html">Dashboard</a>
                        <a class="text-white/70 hover:text-white transition-colors text-sm font-medium leading-normal" href="classes.html">Classes</a>
                        <a class="text-primary text-sm font-bold leading-normal relative" href="#">
                            Upload PDF
                            <span class="absolute -bottom-1 left-0 w-full h-0.5 bg-primary"></span>
                        </a>
                        <a class="text-white/70 hover:text-white transition-colors text-sm font-medium leading-normal" href="ai-content-generator.html">AI Generator</a>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="flex items-center justify-center rounded-full size-10 bg-[#1b2427] border border-[#3b4e54] text-white/70 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-xl">notifications</span>
                    </button>
                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em] hover:shadow-glow-primary transition-shadow">
                        <span class="truncate">Profile</span>
                    </button>
                </div>
            </header>
            <main class="flex-1 px-10 py-8">
                <div class="flex flex-col gap-8 max-w-4xl mx-auto">
                    <div class="flex flex-col gap-3">
                        <p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">Upload PDF & Create Assignment</p>
                        <p class="text-[#9cb2ba] text-base font-normal leading-normal">Transform your PDF notes into personalized learning experiences for your students.</p>
                    </div>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <div class="text-white font-medium">Upload PDF</div>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <div class="text-[#9cb2ba]">Review Content</div>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-number">3</div>
                            <div class="text-[#9cb2ba]">Assign to Class</div>
                        </div>
                    </div>
                    
                    <!-- Step 1: Upload PDF -->
                    <div class="bg-[#1b2427]/50 border border-[#283539] rounded-xl p-6" id="upload-section">
                        <h3 class="text-2xl font-bold text-white mb-6">Step 1: Upload PDF Notes</h3>
                        
                        <div class="flex flex-col gap-6">
                            <div class="flex flex-col w-full">
                                <p class="text-white text-base font-medium leading-normal pb-2">Assignment Title</p>
                                <input type="text" id="assignment-title" class="form-input flex w-full min-w-0 resize-none overflow-hidden rounded-lg text-white focus:outline-0 border border-[#3b4e54] bg-[#101e22] focus:border-primary focus:ring-2 focus:ring-primary/50 h-14 p-[15px] text-base font-normal leading-normal transition-all" placeholder="e.g., Introduction to Photosynthesis">
                            </div>
                            
                            <div class="flex flex-col w-full">
                                <p class="text-white text-base font-medium leading-normal pb-2">PDF File</p>
                                <div class="upload-area rounded-lg p-8 text-center cursor-pointer transition-all" id="drop-area">
                                    <div class="flex flex-col items-center justify-center">
                                        <span class="material-symbols-outlined text-5xl text-[#9cb2ba] mb-4">upload_file</span>
                                        <p class="text-white text-lg font-medium mb-2">Drag & drop your PDF here</p>
                                        <p class="text-[#9cb2ba] text-sm mb-4">or</p>
                                        <button class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em]">
                                            Browse Files
                                        </button>
                                        <p class="text-[#9cb2ba] text-xs mt-4">Supports PDF files up to 10MB</p>
                                        <input type="file" id="pdf-file" accept=".pdf" class="hidden">
                                    </div>
                                </div>
                                <div id="file-info" class="mt-4 hidden">
                                    <div class="flex items-center justify-between p-3 bg-[#101e22] rounded-lg">
                                        <div class="flex items-center">
                                            <span class="material-symbols-outlined text-primary text-2xl mr-3">picture_as_pdf</span>
                                            <div>
                                                <p class="text-white font-medium" id="file-name">filename.pdf</p>
                                                <p class="text-[#9cb2ba] text-sm" id="file-size">0 KB</p>
                                            </div>
                                        </div>
                                        <button class="text-[#9cb2ba] hover:text-white" id="remove-file">
                                            <span class="material-symbols-outlined">close</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                <button id="process-btn" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-background-dark text-base font-bold leading-normal tracking-[0.015em] hover:shadow-glow-primary transition-shadow duration-300" disabled>
                                    <span class="truncate">Process PDF</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: Review Content (Hidden by default) -->
                    <div class="bg-[#1b2427]/50 border border-[#283539] rounded-xl p-6 hidden" id="review-section">
                        <h3 class="text-2xl font-bold text-white mb-6">Step 2: Review Extracted Content</h3>
                        
                        <div class="flex flex-col gap-6">
                            <div class="bg-[#101e22] rounded-lg p-5">
                                <h4 class="text-white font-bold text-lg mb-3">Extracted Concepts</h4>
                                <div id="concepts-container" class="space-y-4">
                                    <!-- Concepts will be loaded here -->
                                    <div class="text-center py-8 text-[#9cb2ba]">
                                        <span class="material-symbols-outlined text-3xl mb-2 block">hourglass_empty</span>
                                        <p>Processing PDF content...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <button id="back-to-upload" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-transparent border-2 border-primary text-primary text-base font-bold leading-normal hover:bg-primary/10 transition-colors">
                                    <span class="material-symbols-outlined mr-2">arrow_back</span>
                                    <span class="truncate">Back</span>
                                </button>
                                <button id="assign-btn" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-background-dark text-base font-bold leading-normal tracking-[0.015em] hover:shadow-glow-primary transition-shadow duration-300">
                                    <span class="truncate">Assign to Class</span>
                                    <span class="material-symbols-outlined ml-2">arrow_forward</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Assign to Class (Hidden by default) -->
                    <div class="bg-[#1b2427]/50 border border-[#283539] rounded-xl p-6 hidden" id="assign-section">
                        <h3 class="text-2xl font-bold text-white mb-6">Step 3: Assign to Class</h3>
                        
                        <div class="flex flex-col gap-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="flex flex-col w-full">
                                    <p class="text-white text-base font-medium leading-normal pb-2">Select Class</p>
                                    <div class="select-wrapper">
                                        <select id="class-select" class="form-select flex w-full min-w-0 resize-none overflow-hidden rounded-lg text-white focus:outline-0 border border-[#3b4e54] bg-[#101e22] focus:border-primary focus:ring-2 focus:ring-primary/50 h-14 p-[15px] text-base font-normal leading-normal transition-all">
                                            <option value="">Select a class</option>
                                            <!-- Classes will be populated here -->
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex flex-col w-full">
                                    <p class="text-white text-base font-medium leading-normal pb-2">Due Date</p>
                                    <input type="date" id="due-date" class="form-input flex w-full min-w-0 resize-none overflow-hidden rounded-lg text-white focus:outline-0 border border-[#3b4e54] bg-[#101e22] focus:border-primary focus:ring-2 focus:ring-primary/50 h-14 p-[15px] text-base font-normal leading-normal transition-all">
                                </div>
                            </div>
                            
                            <div class="flex flex-col w-full">
                                <p class="text-white text-base font-medium leading-normal pb-2">Additional Instructions (Optional)</p>
                                <textarea id="instructions" class="form-input flex w-full min-w-0 resize-y overflow-hidden rounded-lg text-white focus:outline-0 border border-[#3b4e54] bg-[#101e22] focus:border-primary focus:ring-2 focus:ring-primary/50 h-28 placeholder:text-[#9cb2ba] p-[15px] text-base font-normal leading-normal transition-all" placeholder="Add any specific instructions for your students..."></textarea>
                            </div>
                            
                            <div class="bg-[#101e22] rounded-lg p-5">
                                <h4 class="text-white font-bold text-lg mb-3">Assignment Preview</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-[#9cb2ba]">Title:</span>
                                        <span class="text-white font-medium" id="preview-title">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-[#9cb2ba]">Concepts:</span>
                                        <span class="text-white font-medium" id="preview-concepts">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-[#9cb2ba]">Adaptive Features:</span>
                                        <span class="text-white font-medium">Enabled</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <button id="back-to-review" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-transparent border-2 border-primary text-primary text-base font-bold leading-normal hover:bg-primary/10 transition-colors">
                                    <span class="material-symbols-outlined mr-2">arrow_back</span>
                                    <span class="truncate">Back</span>
                                </button>
                                <button id="finalize-assignment" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-background-dark text-base font-bold leading-normal tracking-[0.015em] hover:shadow-glow-primary transition-shadow duration-300">
                                    <span class="truncate">Create Assignment</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Success Message (Hidden by default) -->
                    <div class="bg-[#1b2427]/50 border border-[#283539] rounded-xl p-6 hidden" id="success-section">
                        <div class="text-center py-8">
                            <span class="material-symbols-outlined text-5xl text-primary mb-4 block">check_circle</span>
                            <h3 class="text-2xl font-bold text-white mb-2">Assignment Created Successfully!</h3>
                            <p class="text-[#9cb2ba] mb-6">Your PDF content has been transformed into an adaptive learning experience and assigned to your class. You can view it in the class details page under the "PDF Lessons" section.</p>
                            <div class="flex justify-center gap-4">
                                <a href="classes.html" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-background-dark text-base font-bold leading-normal tracking-[0.015em] hover:shadow-glow-primary transition-shadow duration-300">
                                    <span class="truncate">View Classes</span>
                                </a>
                                <a href="#" id="create-another" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-transparent border-2 border-primary text-primary text-base font-bold leading-normal hover:bg-primary/10 transition-colors">
                                    <span class="truncate">Create Another</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        // Import API service
        import { teacherAPI } from '../src/services/api.js';
        
        // Define API base URL
        const API_BASE_URL = 'http://localhost:8000';
        
        // DOM Elements
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('pdf-file');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const removeFileBtn = document.getElementById('remove-file');
        const processBtn = document.getElementById('process-btn');
        const assignmentTitle = document.getElementById('assignment-title');
        
        // Step elements
        const uploadSection = document.getElementById('upload-section');
        const reviewSection = document.getElementById('review-section');
        const assignSection = document.getElementById('assign-section');
        const successSection = document.getElementById('success-section');
        
        // Navigation buttons
        const assignBtn = document.getElementById('assign-btn');
        const backToUpload = document.getElementById('back-to-upload');
        const backToReview = document.getElementById('back-to-review');
        const finalizeAssignment = document.getElementById('finalize-assignment');
        const createAnother = document.getElementById('create-another');
        
        // Preview elements
        const previewTitle = document.getElementById('preview-title');
        const previewConcepts = document.getElementById('preview-concepts');
        
        // State variables
        let uploadedFile = null;
        let extractedConcepts = [];
        
        // Event Listeners
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        removeFileBtn.addEventListener('click', removeFile);
        processBtn.addEventListener('click', processPDF);
        assignBtn.addEventListener('click', showAssignSection);
        backToUpload.addEventListener('click', showUploadSection);
        backToReview.addEventListener('click', showReviewSection);
        finalizeAssignment.addEventListener('click', createAssignment);
        createAnother.addEventListener('click', resetForm);
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('drag-over');
        }
        
        function unhighlight() {
            dropArea.classList.remove('drag-over');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                handleFiles(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            if (e.target.files.length) {
                handleFiles(e.target.files[0]);
            }
        }
        
        function handleFiles(file) {
            // Check if file is PDF
            if (file.type !== 'application/pdf') {
                alert('Please select a PDF file.');
                return;
            }
            
            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                alert('File size exceeds 10MB limit.');
                return;
            }
            
            uploadedFile = file;
            
            // Update UI
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.remove('hidden');
            processBtn.disabled = false;
            
            // Update assignment title if empty
            if (!assignmentTitle.value.trim()) {
                // Use filename without extension as title and add PDF indicator
                const title = file.name.replace(/\.[^/.]+$/, "");
                assignmentTitle.value = `[PDF] ${title.charAt(0).toUpperCase() + title.slice(1)}`;
            }
        }
        
        function removeFile() {
            uploadedFile = null;
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            processBtn.disabled = true;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function processPDF() {
            if (!uploadedFile) {
                alert('Please select a PDF file first.');
                return;
            }
            
            if (!assignmentTitle.value.trim()) {
                alert('Please enter an assignment title.');
                return;
            }
            
            // Show processing state
            const originalText = processBtn.innerHTML;
            processBtn.innerHTML = '<span class="truncate">Processing...</span>';
            processBtn.disabled = true;
            
            try {
                // Create FormData for PDF upload
                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('assignment_title', assignmentTitle.value);
                
                // Log FormData for debugging
                console.log('Sending FormData:');
                for (let [key, value] of formData.entries()) {
                    console.log(key, value);
                }
                
                // Process PDF through backend API
                const result = await teacherAPI.processPDF(formData);
                
                // Log result for debugging
                console.log('Received result:', result);
                console.log('Result type:', typeof result);
                console.log('Result keys:', Object.keys(result || {}));
                
                // Store extracted concepts - ensure it's an array
                if (result && result.concepts) {
                    console.log('Concepts type:', typeof result.concepts);
                    console.log('Is concepts an array?', Array.isArray(result.concepts));
                    
                    if (Array.isArray(result.concepts)) {
                        extractedConcepts = result.concepts;
                    } else if (typeof result.concepts === 'object') {
                        // If it's a single concept object, wrap it in an array
                        extractedConcepts = [result.concepts];
                    } else {
                        // If it's something else, create an empty array
                        extractedConcepts = [];
                    }
                } else {
                    console.log('No concepts found in result');
                    extractedConcepts = [];
                }
                
                console.log('Extracted concepts:', extractedConcepts);
                console.log('Extracted concepts type:', typeof extractedConcepts);
                console.log('Is extracted concepts an array?', Array.isArray(extractedConcepts));
                
                // Display concepts in review section
                displayConcepts(extractedConcepts);
                
                // Show review section
                showReviewSection();
            } catch (error) {
                console.error('Error processing PDF:', error);
                // Try to get more detailed error information
                let errorMessage = 'Failed to process PDF';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                } else if (typeof error === 'object' && error !== null) {
                    // Check if it's a validation error from the backend
                    if (error.detail) {
                        errorMessage += ': ' + error.detail;
                    } else {
                        // Try to stringify the error object
                        try {
                            errorMessage += ': ' + JSON.stringify(error);
                        } catch (stringifyError) {
                            errorMessage += ': Unable to parse error details';
                        }
                    }
                } else {
                    errorMessage += ': Unknown error occurred';
                }
                
                // Provide specific guidance for common issues
                if (errorMessage.includes('GEMINI_API_KEY')) {
                    errorMessage += '\n\nPlease ensure the GEMINI_API_KEY is configured on the server.';
                } else if (errorMessage.includes('PDF')) {
                    errorMessage += '\n\nPlease ensure you are uploading a valid PDF file.';
                }
                
                alert(errorMessage);
            } finally {
                processBtn.innerHTML = originalText;
                processBtn.disabled = false;
            }
        }
        
        function displayConcepts(concepts) {
            const container = document.getElementById('concepts-container');
            
            // Ensure concepts is an array
            let conceptsArray = [];
            if (Array.isArray(concepts)) {
                conceptsArray = concepts;
            } else if (concepts && typeof concepts === 'object') {
                conceptsArray = [concepts];
            }
            
            if (!conceptsArray || conceptsArray.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-[#9cb2ba]">
                        <span class="material-symbols-outlined text-3xl mb-2 block">info</span>
                        <p>No concepts were extracted from the PDF. Please try another file.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            conceptsArray.forEach((concept, index) => {
                // Handle both the AI-extracted concept structure and a fallback structure
                const name = concept.name || concept.concept || 'Unknown Concept';
                const description = concept.description || concept.definition || 'No description available';
                const difficulty = concept.difficulty || 'medium';
                const estimatedTime = concept.estimatedTime || 30; // Default to 30 minutes
                
                html += `
                    <div class="p-4 bg-[#1b2427] rounded-lg border border-[#3b4e54]">
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="text-white font-bold text-lg">${name}</h5>
                                <p class="text-[#9cb2ba] mt-1">${description}</p>
                            </div>
                            <span class="px-2 py-1 bg-primary/10 text-primary text-xs font-medium rounded-full">${difficulty}</span>
                        </div>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-[#9cb2ba] text-sm">Estimated time: ${estimatedTime} minutes</span>
                            <div class="flex items-center text-primary">
                                <span class="material-symbols-outlined text-sm mr-1">auto_awesome</span>
                                <span class="text-sm">Adaptive Learning</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Update preview
            previewTitle.textContent = assignmentTitle.value;
            previewConcepts.textContent = `${conceptsArray.length} concepts`;
        }
        
        function showUploadSection() {
            // Update step indicator
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.remove('active');
            
            // Show/hide sections
            uploadSection.classList.remove('hidden');
            reviewSection.classList.add('hidden');
            assignSection.classList.add('hidden');
            successSection.classList.add('hidden');
        }
        
        function showReviewSection() {
            // Update step indicator
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.remove('active');
            
            // Show/hide sections
            uploadSection.classList.add('hidden');
            reviewSection.classList.remove('hidden');
            assignSection.classList.add('hidden');
            successSection.classList.add('hidden');
            
            // Load classes for assignment
            loadClasses();
        }
        
        function showAssignSection() {
            // Update step indicator
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            
            // Show/hide sections
            uploadSection.classList.add('hidden');
            reviewSection.classList.add('hidden');
            assignSection.classList.remove('hidden');
            successSection.classList.add('hidden');
        }
        
        function showSuccessSection() {
            // Update step indicator
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step3').classList.remove('active');
            
            // Show/hide sections
            uploadSection.classList.add('hidden');
            reviewSection.classList.add('hidden');
            assignSection.classList.add('hidden');
            successSection.classList.remove('hidden');
        }
        
        async function loadClasses() {
            try {
                const classSelect = document.getElementById('class-select');
                classSelect.innerHTML = '<option value="">Loading classes...</option>';
                
                // Fetch classes using the teacherAPI (same as classes.html)
                const classes = await teacherAPI.getClasses();
                
                console.log('Loaded classes:', classes);
                
                if (!classes || classes.length === 0) {
                    classSelect.innerHTML = '<option value="">No classes found</option>';
                    return;
                }
                
                let optionsHtml = '<option value="">Select a class</option>';
                classes.forEach(cls => {
                    optionsHtml += `<option value="${cls.id}">${cls.name}</option>`;
                });
                
                classSelect.innerHTML = optionsHtml;
            } catch (error) {
                console.error('Error loading classes:', error);
                document.getElementById('class-select').innerHTML = '<option value="">Failed to load classes</option>';
            }
        }
        

                async function createAssignment() {
            const classId = document.getElementById('class-select').value;
            const dueDate = document.getElementById('due-date').value;
            const instructions = document.getElementById('instructions').value;
            
            if (!classId) {
                alert('Please select a class.');
                return;
            }

            if (!uploadedFile) {
                alert('Please select a PDF file.');
                return;
            }
            
            // Show processing state
            const originalText = finalizeAssignment.innerHTML;
            finalizeAssignment.innerHTML = '<span class="truncate">Creating...</span>';
            finalizeAssignment.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('assignment_title', assignmentTitle.value);
                formData.append('description', instructions || `Adaptive learning assignment based on PDF content: ${assignmentTitle.value}.`);
                formData.append('class_ids', JSON.stringify([parseInt(classId, 10)]));
                if (dueDate) {
                    formData.append('due_date', new Date(dueDate).toISOString());
                }

                const result = await teacherAPI.createAdaptiveAssignment(formData);

                console.log('Create adaptive assignment result:', result);

                // Show success
                showSuccessSection();

            } catch (error) {
                console.error('Error creating assignment:', error);
                let errorMessage = 'Failed to create assignment';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                alert(errorMessage);
            } finally {
                finalizeAssignment.innerHTML = originalText;
                finalizeAssignment.disabled = false;
            }
        }
        
        function resetForm(e) {
            if (e) e.preventDefault();
            
            // Reset form
            assignmentTitle.value = '';
            removeFile();
            document.getElementById('class-select').selectedIndex = 0;
            document.getElementById('due-date').value = '';
            document.getElementById('instructions').value = '';
            
            // Reset state
            extractedConcepts = [];
            
            // Show upload section
            showUploadSection();
        }
        
        // Set default due date to 1 week from now
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const dueDate = new Date();
            dueDate.setDate(today.getDate() + 7);
            
            // Format as YYYY-MM-DD
            const formattedDate = dueDate.toISOString().split('T')[0];
            document.getElementById('due-date').value = formattedDate;
        });
    </script>
</body>
</html>