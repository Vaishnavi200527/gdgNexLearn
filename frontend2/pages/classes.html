<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AMEP Class Management (Dark Mode)</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#0db9f2",
              "background-light": "#f5f8f8",
              "background-dark": "#101e22",
            },
            fontFamily: {
              "display": ["Inter"]
            },
            borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px"},
          },
        },
      }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
<body class="font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-dark dark group/design-root overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">
<div class="px-4 sm:px-8 md:px-16 lg:px-24 xl:px-40 flex flex-1 justify-center py-5">
<div class="layout-content-container flex flex-col max-w-[960px] flex-1">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-primary/20 px-4 sm:px-10 py-3">
<div class="flex items-center gap-8">
<div class="flex items-center gap-4 text-white">
<img src="../assets/logo.png" alt="AMEP Logo" class="h-8 w-8 text-primary" />
<h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">AMEP</h2>
</div>
<div class="hidden md:flex items-center gap-9">
<a class="text-white text-sm font-medium leading-normal hover:text-primary transition-colors" href="teacher-dashboard.html">Dashboard</a>
<a class="text-primary text-sm font-bold leading-normal" href="classes.html">Classes</a>
<a class="text-white text-sm font-medium leading-normal hover:text-primary transition-colors" href="student-progress.html">Students</a>
<a class="text-white text-sm font-medium leading-normal hover:text-primary transition-colors" href="interventions.html">Reports</a>
</div>
</div>
<div class="flex flex-1 justify-end gap-4 sm:gap-8">
<label class="hidden sm:flex flex-col min-w-40 !h-10 max-w-64">
<div class="flex w-full flex-1 items-stretch rounded-xl h-full">
<div class="text-[#9cb2ba] flex border-none bg-[#283539] items-center justify-center pl-4 rounded-l-xl border-r-0">
<span class="material-symbols-outlined text-2xl">search</span>
</div>
<input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border-none bg-[#283539] focus:border-none h-full placeholder:text-[#9cb2ba] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal" placeholder="Search" value=""/>
</div>
</label>
<button id="create-class-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity shadow-[0_0_15px_rgba(13,185,242,0.5)]">
<span class="truncate">Create Class</span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" data-alt="User avatar placeholder" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD8PZmOT22a0w5Q4nzo7eXpKfIrj2fpNLgAJzB8NL4aw8mCQcjZlhocwvUTbNacm0yrTxVNHRI0NKEAZUtJN90uv3VZNC-a35Zycyu2Y-7PeK-2iq-7Kpu7yb9k56siCp_Ia1bnHM_2tnfV1URzoMGAQNNAXA5FqBcAA_ZH4a13RnfZnlQuFs2S4tpLpVRXgZFsKFkqoqMFbRVP8k40qaoBzwMOjrCigdbR25FU8TFRjDe-k3j6MWQPiOCYPIJQlnLvZyy6ZZMKvfE");'></div>
</div>
</header>
<main class="flex-1 mt-8">
<div class="flex flex-wrap justify-between gap-3 p-4">
<div class="flex min-w-72 flex-col gap-3">
<p class="text-white text-4xl font-black leading-tight tracking-[-0.033em]">Class Management</p>
<p class="text-[#9cb2ba] text-base font-normal leading-normal">Manage your classes and enroll students</p>
</div>
</div>

<!-- Create Class Form (Hidden by default) -->
<div id="create-class-form" class="hidden flex-col gap-6 p-6 rounded-xl bg-[#283539] mt-6">
<div class="flex flex-col gap-2">
<label class="text-white text-sm font-medium leading-normal">Class Name</label>
<input type="text" id="class-name" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-12 px-4 text-base font-normal leading-normal" placeholder="Enter class name">
</div>
<div class="flex flex-col gap-2">
<label class="text-white text-sm font-medium leading-normal">Description</label>
<textarea id="class-description" class="form-textarea flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-24 px-4 py-3 text-base font-normal leading-normal" placeholder="Enter class description"></textarea>
</div>
<button id="save-class-btn" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
<span class="truncate">Save Class</span>
</button>
</div>

<!-- Classes List -->
<div class="flex flex-col gap-6 mt-6">
<h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Your Classes</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="classes-container">
<div class="text-center py-8 text-[#9cb2ba]">Loading classes...</div>
</div>
</div>

<!-- Create Project Form (placed below Classes list) -->
<div id="create-project-section" class="mt-8">
    <div class="flex items-center justify-between">
        <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Projects</h2>
        <button id="create-project-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity shadow-[0_0_15px_rgba(13,185,242,0.5)]">
            <span class="truncate">Create Project</span>
        </button>
    </div>

    <!-- Create Project Form (Hidden by default) -->
    <div id="create-project-form" class="hidden flex-col gap-6 p-6 rounded-xl bg-[#283539] mt-6">
        <div class="flex flex-col gap-2">
            <label class="text-white text-sm font-medium leading-normal">Project Title</label>
            <input type="text" id="project-title" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-12 px-4 text-base font-normal leading-normal" placeholder="Enter project title">
        </div>
        <div class="flex flex-col gap-2">
            <label class="text-white text-sm font-medium leading-normal">Description</label>
            <textarea id="project-description" class="form-textarea flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-24 px-4 py-3 text-base font-normal leading-normal" placeholder="Enter project description"></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="flex flex-col gap-2">
                <label class="text-white text-sm font-medium leading-normal">Skill Area (optional)</label>
                <input type="text" id="project-skill-area" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-12 px-4 text-base font-normal leading-normal" placeholder="e.g., Web Dev, Data Analysis">
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-white text-sm font-medium leading-normal">Duration (hours)</label>
                <input type="number" id="project-duration" min="1" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-12 px-4 text-base font-normal leading-normal" placeholder="e.g., 20">
            </div>
        </div>
        <div class="flex flex-col gap-2">
            <label class="text-white text-sm font-medium leading-normal">Team Size</label>
            <input type="number" id="project-team-size" min="1" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-12 px-4 text-base font-normal leading-normal" placeholder="e.g., 3">
        </div>
        <button id="save-project-btn" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
            <span class="truncate">Save Project</span>
        </button>
    </div>

    <!-- Projects List -->
    <div id="projects-container" class="mt-6">
        <!-- Projects will be listed here after creation or via API call -->
    </div>
</div>

<!-- Enroll Students Section -->
<div class="flex flex-col gap-6 mt-8">
<h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Enroll Students</h2>
<div class="flex flex-col gap-4 rounded-xl p-6 bg-[#283539]">
<div class="flex flex-col gap-2">
<label class="text-white text-sm font-medium leading-normal">Class</label>
<select id="class-select" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-12 px-4 text-base font-normal leading-normal">
<option value="">Select a class</option>
</select>
</div>
<div class="flex flex-col gap-2">
<label class="text-white text-sm font-medium leading-normal">Student ID</label>
<input type="number" id="student-id-input" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-[#9cb2ba]/30 bg-[#101e22] h-12 px-4 text-base font-normal leading-normal" placeholder="Enter student ID">
</div>
<button id="enroll-student-btn" class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-background-dark text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
<span class="truncate">Enroll Student</span>
</button>
</div>
</div>
</main>
</div>
</div>
</div>
</div>

<script type="module">
    // Import API service
    import { teacherAPI } from '../src/services/api.js';
    import { logout } from '../src/services/auth.js';
    
    // DOM Elements
    const createClassBtn = document.getElementById('create-class-btn');
    const createClassForm = document.getElementById('create-class-form');
    const saveClassBtn = document.getElementById('save-class-btn');
    const classesContainer = document.getElementById('classes-container');
    const classSelect = document.getElementById('class-select');
    const enrollStudentBtn = document.getElementById('enroll-student-btn');
    
    // Toggle create class form
    createClassBtn.addEventListener('click', () => {
        createClassForm.classList.toggle('hidden');
    });
    
    // Save new class
    saveClassBtn.addEventListener('click', async () => {
        const className = document.getElementById('class-name').value;
        const classDescription = document.getElementById('class-description').value;
        
        if (!className) {
            alert('Please enter a class name');
            return;
        }
        
        try {
            const classData = {
                name: className,
                description: classDescription
                // Note: teacher_id is not sent from frontend as it's set by the backend from the authenticated user
            };
            
            await teacherAPI.createClass(classData);
            alert('Class created successfully!');
            
            // Reset form
            document.getElementById('class-name').value = '';
            document.getElementById('class-description').value = '';
            createClassForm.classList.add('hidden');
            
            // Refresh classes list
            loadClasses();
        } catch (error) {
            console.error('Error creating class:', error);
            alert('Failed to create class: ' + error.message);
        }
    });
    
    // Enroll student in class
    enrollStudentBtn.addEventListener('click', async () => {
        const classId = parseInt(classSelect.value);
        const studentId = parseInt(document.getElementById('student-id-input').value);
        
        if (!classId) {
            alert('Please select a class');
            return;
        }
        
        if (!studentId) {
            alert('Please enter a student ID');
            return;
        }
        
        try {
            const enrollmentData = {
                student_id: studentId
            };
            
            await teacherAPI.enrollStudent(classId, enrollmentData);
            alert('Student enrolled successfully!');
            
            // Reset form
            document.getElementById('student-id-input').value = '';
        } catch (error) {
            console.error('Error enrolling student:', error);
            alert('Failed to enroll student: ' + (error.message || 'Unknown error occurred'));
        }
    });
    
    // Load classes
    async function loadClasses() {
        try {
            const classes = await teacherAPI.getClasses();
            displayClasses(classes);
            populateClassSelect(classes);
        } catch (error) {
            console.error('Error loading classes:', error);
            classesContainer.innerHTML = '<div class="text-center py-8 text-[#9cb2ba]">Failed to load classes</div>';
        }
    }
    
    // Display classes
    function displayClasses(classes) {
        if (!classes || classes.length === 0) {
            classesContainer.innerHTML = '<div class="text-center py-8 text-[#9cb2ba]">No classes found. Create your first class!</div>';
            return;
        }
        
        classesContainer.innerHTML = '';
        
        classes.forEach(cls => {
            const classCard = document.createElement('div');
            classCard.className = 'flex flex-col gap-4 rounded-xl p-6 bg-[#283539] border border-primary/30 hover:border-primary/60 transition-colors cursor-pointer';
            classCard.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex size-12 items-center justify-center rounded-lg bg-primary/10 text-primary">
                        <span class="material-symbols-outlined text-2xl">school</span>
                    </div>
                    <div class="flex flex-col">
                        <p class="text-white font-bold text-lg">${cls.name}</p>
                        <p class="text-[#9cb2ba] text-sm">${cls.description || 'No description'}</p>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="material-symbols-outlined text-[#9cb2ba]">calendar_today</span>
                        <span class="text-[#9cb2ba] text-sm">${new Date(cls.created_at).toLocaleDateString()}</span>
                    </div>
                    <a href="class-details.html?class_id=${cls.id}" class="text-primary text-sm font-bold hover:underline">
                        View Details
                    </a>
                </div>
            `;
            
            classesContainer.appendChild(classCard);
        });
    }
    
    // Populate class select dropdown
    function populateClassSelect(classes) {
        classSelect.innerHTML = '<option value="">Select a class</option>';
        
        if (!classes || classes.length === 0) {
            return;
        }
        
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.id;
            option.textContent = cls.name;
            classSelect.appendChild(option);
        });
    }

    // --- Project creation UI handlers ---
    const createProjectBtn = document.getElementById('create-project-btn');
    const createProjectForm = document.getElementById('create-project-form');
    const saveProjectBtn = document.getElementById('save-project-btn');
    const projectsContainer = document.getElementById('projects-container');

    // Toggle project form visibility
    createProjectBtn.addEventListener('click', () => {
        createProjectForm.classList.toggle('hidden');
    });

    // Save new project
    saveProjectBtn.addEventListener('click', async () => {
        const title = document.getElementById('project-title').value.trim();
        const description = document.getElementById('project-description').value.trim();
        const skillArea = document.getElementById('project-skill-area').value.trim();
        const duration = parseInt(document.getElementById('project-duration').value) || null;
        const teamSize = parseInt(document.getElementById('project-team-size').value) || null;

        if (!title) {
            alert('Please enter a project title');
            return;
        }

        try {
            // Build project payload; backend will set teacher_id
            const projectData = {
                title,
                description,
                start_date: new Date().toISOString(),
                end_date: null
            };

            // Attach optional fields in a non-breaking way (backend ignores unknown fields)
            if (skillArea) projectData.skill_area = skillArea;
            if (duration) projectData.duration_hours = duration;
            if (teamSize) projectData.team_size = teamSize;

            const created = await teacherAPI.createProjects(projectData);
            alert('Project created successfully!');

            // Reset form
            document.getElementById('project-title').value = '';
            document.getElementById('project-description').value = '';
            document.getElementById('project-skill-area').value = '';
            document.getElementById('project-duration').value = '';
            document.getElementById('project-team-size').value = '';
            createProjectForm.classList.add('hidden');

            // Append to projects container for immediate feedback
            appendProjectCard(created);
        } catch (error) {
            console.error('Error creating project:', error);
            alert('Failed to create project: ' + (error.message || 'Unknown error occurred'));
        }
    });

    function appendProjectCard(project) {
        if (!project) return;
        const card = document.createElement('div');
        card.className = 'flex flex-col gap-4 rounded-xl p-6 bg-[#283539] border border-primary/30 hover:border-primary/60 transition-colors';
        card.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="flex size-12 items-center justify-center rounded-lg bg-primary/10 text-primary">
                    <span class="material-symbols-outlined text-2xl">work</span>
                </div>
                <div class="flex flex-col">
                    <p class="text-white font-bold text-lg">${project.title}</p>
                    <p class="text-[#9cb2ba] text-sm">${project.description || ''}</p>
                </div>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-[#9cb2ba]">calendar_today</span>
                    <span class="text-[#9cb2ba] text-sm">${project.start_date ? new Date(project.start_date).toLocaleDateString() : ''}</span>
                </div>
                <button class="text-primary text-sm font-bold hover:underline assign-project-btn" data-project-id="${project.id}">Assign to class</button>
            </div>
        `;
        projectsContainer.prepend(card);
    }

    // Event delegation for assigning projects to the selected class
    projectsContainer.addEventListener('click', async (e) => {
        if (e.target.classList.contains('assign-project-btn')) {
            const projectId = parseInt(e.target.getAttribute('data-project-id'));
            const classId = parseInt(classSelect.value);
            if (!classId) {
                alert('Select a class from the enroll section to assign this project to.');
                return;
            }
            try {
                await teacherAPI.assignProjectToClass(classId, { project_id: projectId });
                alert('Project assigned to class!');
            } catch (err) {
                console.error('Error assigning project:', err);
                alert('Failed to assign project: ' + (err.message || err));
            }
        }
    });

    // View class details
    window.viewClassDetails = function(classId) {
        // Navigate to class details page
        window.location.href = `class-details.html?class_id=${classId}`;
    };

    // Load classes when page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadClasses();
    });
</script>
</body>
</html>